# Puzzle Solver Requirements Document (PRD)

## Overview
This document outlines the product requirements for the solver of an agentic virtual assisstant to assist a human in solving the New York Time Connection Puzzle.  The assisant will be able to read the puzzle, make recommendations, and provide feedback on the recommendations to the human.  The assistant uses generative AI technologies to provide the recommendations modify recommendations based on the feedback.  


# User Stories
| User Story ID | Description                                                                 | Acceptance Criteria                                                                                                                                                                                                                     |
|---------------|-----------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| SOLVER001         | As a user, I want to initialize the puzzle so that I can start solving it. | - The `setup_puzzle` function initializes the puzzle state with default values. <br> - Vocabulary and embeddings are generated for the words in `words_remaining`. <br> - The vocabulary is stored in an external database.             |
| SOLVER001.001         | As a user, I want the system to initialize the puzzle so I can start solving it. | - The system initializes the puzzle state with default values (e.g., `puzzle_status`, `tool_status`, `mistake_count`, etc.).<br>- The system generates a vocabulary and embeddings for the provided words.<br>- The vocabulary and embeddings are stored in an external database. |
| SOLVER001.002         | As a user, I want the system to suggest groups of related words so I can solve the puzzle. | - The system generates candidate word groups based on cosine similarity of embeddings.<br>- The system ensures that groups are unique and sorted by their similarity metric.<br>- The system validates the top candidate groups using an LLM. |
| SOLVER001.003         | As a user, I want to manually recommend a group of words if the system's suggestions are incorrect. | - The system allows the user to input a manual recommendation of four words.<br>- The system validates that the manual recommendation is a subset of the remaining words.<br>- The user can provide a connection description for the group. |
| SOLVER001.004         | As a user, I want the system to analyze incorrect recommendations to find groups that are close to being correct. | - The system identifies "one-away" groups by analyzing groups that are one word away from being correct.<br>- The system uses an LLM to validate and recommend a corrected group.<br>- The system ensures the corrected group is not a prior mistake. |
| SOLVER001.005         | As a user, I want the system to apply recommendations and update the puzzle state based on my feedback. | - The system updates the puzzle state based on whether the recommendation was correct or incorrect.<br>- Correct groups are removed from the database and the remaining words.<br>- Incorrect groups are tracked to avoid repeating mistakes.<br>- The system transitions to the next tool or recommendation based on the feedback. |
| SOLVER001.006         | As a user, I want the system to switch between different recommendation tools to improve accuracy. | - The system can switch between tools like `embedvec_recommender`, `llm_recommender`, and `manual_recommender` based on the situation.<br>- The system retries recommendations up to a defined limit (`RETRY_LIMIT`). |
| SOLVER001.007         | As a user, I want the system to notify me when the puzzle is solved or when it cannot be solved. | - The system logs and prints a success message when the puzzle is solved.<br>- The system logs and prints a failure message if the maximum number of mistakes (`MAX_ERRORS`) is reached.<br>- The system updates the tool status to `puzzle_completed`. |
| SOLVER002         | As a user, I want to group similar words together to find connections.     | - The `get_candidate_words` function generates groups of words based on cosine similarity of their embeddings. <br> - Groups are sorted by their similarity metric. <br> - Duplicate groups are removed from the candidate list.         |
| SOLVER002.001           | As a user, I want to find groups of similar words based on their meanings, so I can analyze related terms. | The system should calculate cosine similarity between word embeddings and identify the top 3 closest words for each word. |
| SOLVER002.002           | As a user, I want to ensure that the groups of similar words are unique, so I can avoid duplicate results. | The system should remove duplicate word groups by checking for unique group IDs.                        |
| SOLVER002.003           | As a user, I want the groups of similar words to be ranked, so I can focus on the most relevant ones.      | The system should sort the word groups by their group metric in descending order.                       |
| SOLVER002.004           | As a user, I want to see the relationships between words in a group, so I can understand their connections. | The system should calculate the average cosine similarity for all word pairs in a group to determine the group metric. |
| SOLVER003         | As a user, I want to manually recommend a group of words and connections.  | - The `get_manual_recommendation` function allows users to input a group of 4 words and a connection. <br> - The function validates the input against the remaining words and ensures the group size is correct.                         |
| SOLVER003.001           | As a user, I want to manually recommend a set of words, so I can provide my own input for solving the puzzle. | The system should allow the user to input a manual recommendation of exactly 4 words from the remaining words. |
| SOLVER003.002           | As a user, I want to confirm my manual recommendation, so I can ensure it is correct before proceeding.      | The system should validate that the manual recommendation is a subset of the remaining words and prompt for confirmation. |
| SOLVER003.003           | As a user, I want to manually define a connection for the recommended words, so I can describe their relationship. | The system should allow the user to input a manual connection and confirm its correctness.              |
| SOLVER003.004           | As a user, I want to see the current recommendations and remaining words, so I can make informed decisions.   | The system should display the current recommended words and the list of remaining words.                |
| SOLVER003.005           | As a user, I want the tool to update the state after my input, so I can proceed with the next steps.          | The system should update the state with the recommended words, connection, and tool status after confirmation. |
| SOLVER004         | As a user, I want the system to recommend word groups using embeddings.    | - The `get_embedvec_recommendation` function retrieves word groups from the database and ranks them based on embeddings. <br> - Invalid groups are filtered out. <br> - The top-ranked group is validated using an LLM.                  |
| SOLVER005         | As a user, I want the system to recommend word groups using an AI model.   | - The `get_llm_recommendation` function uses an LLM to recommend word groups and their connections. <br> - Invalid groups are avoided. <br> - The function retries up to a limit if valid recommendations are not found.                 |
| SOLVER006         | As a user, I want to analyze incorrect recommendations to find close matches. | - The `one_away_analyzer` function identifies groups that are one word away from being correct. <br> - The function uses an LLM to validate and explain the new group. <br> - The analysis excludes previously invalid groups.            |
| SOLVER007         | As a user, I want to apply recommendations to progress in solving the puzzle. | - The `apply_recommendation` function processes user feedback on recommendations. <br> - Correct groups are removed from the database and remaining words. <br> - Incorrect groups are tracked, and the system adapts its strategy.      |
| SOLVER008         | As a user, I want a workflow to guide the puzzle-solving process.          | - The `run_workflow` function orchestrates the puzzle-solving process using a state graph. <br> - Human input is required for setup and feedback. <br> - The workflow transitions between tools based on the current state and results. |
| SOLVER009         | As a user, I want to determine the next action based on the puzzle state.  | - The `determine_next_action` function decides the next tool to use based on the `tool_to_use` field in the state. <br> - The function handles special cases like "ABORT" and "END".                                                     |
| SOLVER010         | As a user, I want to create and manage workflows for solving puzzles.      | - The `create_workflow_graph` function defines a state graph with nodes for each tool and transitions between them. <br> - The workflow supports checkpoints and interruptions for human input.                                          |